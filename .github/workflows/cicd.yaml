name: Deploy to Google Cloud Run with Terraform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  # --- GCP & Artifact Registry ---
  PROJECT_ID: github-action-cve-1
  REGION: asia-southeast1
  SERVICE_NAME: terraform-test
  REPO_NAME: cloud-run-source-deploy
  IMAGE_URL: asia-southeast1-docker.pkg.dev/github-action-cve-1/cloud-run-source-deploy/terraform-test

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # 1. Checkout Source Code
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2. Authenticate with GCP
      # -------------------------------
      - name: Google Cloud Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Verify active account and project
        run: |
          echo "Active account:"
          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          echo "Project:"
          gcloud config get-value core/project

      # -------------------------------
      # 3. Build & Push Docker Image
      # -------------------------------
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ env.IMAGE_URL }}:latest -f Dockerfile.prod .
          docker push ${{ env.IMAGE_URL }}:latest

      # -------------------------------
      # 4. Terraform Setup & Deploy
      # -------------------------------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: falseZ

      - name: Terraform Init
        run: terraform -chdir=terraform init -input=false -no-color

      - name: Terraform Import Cloud Run (if exists)
        run: |
          SERVICE_EXISTS=$(gcloud run services list \
            --region=${{ env.REGION }} \
            --format="value(metadata.name)" \
            --filter="metadata.name=${{ env.SERVICE_NAME }}")

          if [ "$SERVICE_EXISTS" = "${{ env.SERVICE_NAME }}" ]; then
            echo "Cloud Run service exists. Importing into Terraform state..."
            terraform -chdir=terraform import \
              google_cloud_run_service.default \
              ${{ env.REGION }}/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}
          else
            echo "Cloud Run service does not exist. Skipping import."
          fi

      - name: Terraform Plan
        run: terraform -chdir=terraform plan -input=false -no-color -out=tfplan
        env:
          TF_VAR_project_id:   ${{ env.PROJECT_ID }}
          TF_VAR_region:       ${{ env.REGION }}
          TF_VAR_service_name: ${{ env.SERVICE_NAME }}
          TF_VAR_image_url:    ${{ env.IMAGE_URL }}:latest
          TF_VAR_cpu:          "2"
          TF_VAR_memory:       "2Gi"

      - name: Terraform Apply (main only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform -chdir=terraform apply -input=false -no-color -auto-approve tfplan
        env:
          TF_VAR_project_id:   ${{ env.PROJECT_ID }}
          TF_VAR_region:       ${{ env.REGION }}
          TF_VAR_service_name: ${{ env.SERVICE_NAME }}
          TF_VAR_image_url:    ${{ env.IMAGE_URL }}:latest
          TF_VAR_cpu:          "2"
          TF_VAR_memory:       "2Gi"
